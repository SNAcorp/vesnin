# Работа с CSV и тестирование FastAPI приложения

## Введение

В этом документе мы рассмотрим, как правильно организовать работу с CSV-файлами в FastAPI приложении и как написать комплексные тесты для проверки функциональности. Наше приложение представляет собой API для управления пользовательскими данными, хранящимися в CSV формате.

## Структура приложения

Основные компоненты приложения:
- FastAPI сервер с эндпоинтами для работы с пользователями
- Функции для работы с CSV файлами
- Комплексный набор тестов

## Работа с CSV

### Основные функции для работы с CSV

1. **Чтение данных (`get_data`)**:
```python
def get_data() -> List[Dict[str, str]]:
    try:
        df = pd.read_csv(CSV_PATH)
        df.columns = df.columns.str.strip()
        for col in df.columns:
            df[col] = df[col].astype(str).str.strip()
        return df.to_dict('records')
    except FileNotFoundError:
        return []
```

2. **Валидация структуры CSV (`validate_csv_structure`)**:
```python
def validate_csv_structure(file_content: str) -> bool:
    required_columns = {'id', 'name', 'surname', 'second_name', 'email', 'phone_number'}
    try:
        df = pd.read_csv(io.StringIO(file_content))
        columns = set(df.columns.str.strip())
        return required_columns.issubset(columns)
    except Exception:
        return False
```

3. **Добавление данных в CSV (`append_to_csv`)**:
```python
def append_to_csv(file_content: str) -> bool:
    # Создание директории при необходимости
    # Чтение новых данных
    # Обработка дубликатов
    # Сохранение результата
```

### Особенности работы с CSV

1. Очистка данных:
   - Удаление пробелов из названий столбцов
   - Преобразование всех значений в строки
   - Удаление пробелов из значений

2. Обработка дубликатов:
   - Проверка по номеру телефона
   - Сохранение последней версии записи
   - Удаление старых дубликатов

## Тестирование

### Фикстуры

1. **Создание тестового CSV**:
```python
@pytest.fixture
def sample_csv(tmp_path, monkeypatch):
    csv_content = (
        "id,name,surname,second_name,email,phone_number\n"
        "1,Иван,Иванов,Иванович,ivan@example.com,1111111111\n"
        "2,Петр,Петров,Петрович,petrov@example.com,2222222222\n"
    )
    file_path = tmp_path / "test.csv"
    file_path.write_text(csv_content, encoding="utf-8")
    
    import main
    monkeypatch.setattr(main, "CSV_PATH", str(file_path))
    return file_path
```

### Группы тестов

1. **Тесты API эндпоинтов**:
   - Получение списка пользователей
   - Получение конкретного пользователя
   - Обработка ошибок при отсутствии пользователя

2. **Тесты валидации CSV**:
   - Проверка корректной структуры
   - Проверка неполного набора колонок
   - Проверка пустого CSV
   - Проверка некорректного формата

3. **Тесты добавления данных**:
   - Создание нового файла
   - Добавление в существующий файл
   - Обработка дубликатов

4. **Тесты загрузки файлов**:
   - Загрузка валидного CSV
   - Обработка ошибок структуры
   - Обработка ошибок сохранения
   - Обработка ошибок чтения

## Лучшие практики

1. **Работа с файлами**:
   - Использование временных директорий для тестов
   - Правильная очистка после тестов
   - Обработка кодировки (UTF-8)

2. **Мокирование**:
   - Использование `AsyncMock` для асинхронных функций
   - Патчинг путей к файлам
   - Эмуляция ошибок

3. **Структура тестов**:
   - Группировка связанных тестов в классы
   - Использование фикстур для переиспользования кода
   - Проверка как успешных сценариев, так и обработки ошибок

## Выводы

1. Правильная организация работы с CSV требует внимания к:
   - Валидации структуры
   - Обработке дубликатов
   - Очистке данных

2. Тестирование должно охватывать:
   - Все эндпоинты API
   - Обработку ошибок
   - Граничные случаи
   - Работу с файлами

3. Использование временных файлов и моков позволяет:
   - Изолировать тесты
   - Избежать побочных эффектов
   - Тестировать обработку ошибок